<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Professional Betting Bot Analyzer</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 20px; color: #333;
    }
    .container {
      max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #2c3e50, #34495e); color: white;
      padding: 40px 20px; text-align: center;
    }
    .header h1 { font-size: 2.5em; margin-bottom: 10px; }
    .header p { opacity: 0.9; font-size: 1.1em; }
    .content { padding: 40px 20px; }
    .form-group { margin-bottom: 30px; }
    label { display: block; margin-bottom: 10px; font-weight: 600; color: #2c3e50; font-size: 1.1em; }
    input[type="text"] {
      width: 100%; padding: 18px; border: 2px solid #e0e6ed; border-radius: 12px;
      font-size: 16px; transition: border-color 0.3s ease;
    }
    input[type="text"]:focus { outline: none; border-color: #667eea; }
    .btn {
      width: 100%; padding: 20px; border: none; border-radius: 12px; font-size: 18px; font-weight: 600;
      cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px;
    }
    .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
    .btn-success { background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; }
    .btn:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(0,0,0,0.2); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
    .progress { background: #f8f9fa; border-radius: 12px; overflow: hidden; margin: 25px 0; height: 15px; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.5s ease; width: 0%; }
    .status { text-align: center; margin: 25px 0; padding: 20px; border-radius: 12px; font-weight: 500; font-size: 1.1em; }
    .status.testing { background: #e3f2fd; color: #1565c0; }
    .status.completed { background: #e8f5e8; color: #2e7d32; }
    .status.error { background: #ffebee; color: #c62828; }
    .results { margin-top: 40px; }
    .readiness-card {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: 20px; padding: 40px; margin: 30px 0; text-align: center; border: 3px solid;
    }
    .readiness-excellent { border-color: #27ae60; background: linear-gradient(135deg, #d5f4e6, #c8e6c9); }
    .readiness-good { border-color: #3498db; background: linear-gradient(135deg, #e3f2fd, #bbdefb); }
    .readiness-moderate { border-color: #f39c12; background: linear-gradient(135deg, #fff3cd, #ffeaa7); }
    .readiness-insufficient { border-color: #e74c3c; background: linear-gradient(135deg, #ffebee, #ffcdd2); }
    .readiness-title { font-size: 2em; font-weight: bold; margin-bottom: 15px; }
    .readiness-score { font-size: 4em; font-weight: bold; margin: 20px 0; }
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
    .stat-card { background: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .stat-value { font-size: 2.5em; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
    .stat-label { color: #666; font-size: 1em; font-weight: 500; }
    .section { background: #f8f9fa; border-radius: 15px; padding: 25px; margin: 25px 0; }
    .section h3 { margin-bottom: 20px; color: #2c3e50; font-size: 1.5em; display: flex; align-items: center; gap: 10px; }
    .recommendation-item {
      background: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 12px; border-left: 4px solid #667eea; font-size: 1.05em; line-height: 1.4;
    }
    .roadmap-phase {
      background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; border-left: 5px solid #667eea; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .phase-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .phase-title { font-weight: bold; font-size: 1.3em; color: #2c3e50; }
    .phase-duration { background: #667eea; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: 500; }
    .hidden { display: none; }
    @media (max-width: 768px) {
      body { padding: 10px; }
      .content { padding: 25px 15px; }
      .summary-grid { grid-template-columns: repeat(2, 1fr); }
      .readiness-score { font-size: 3em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸ¤– Professional Betting Bot Analyzer</h1>
      <p>Complete SportMonks API analysis for building successful betting prediction bots</p>
    </div>

    <div class="content">
      <form id="analysisForm">
        <div class="form-group">
          <label for="apiToken">SportMonks API Token</label>
          <input type="text" id="apiToken" placeholder="Enter your SportMonks API token..." required autocomplete="off" spellcheck="false"/>
        </div>
        <button type="submit" class="btn btn-primary" id="startBtn">ðŸš€ Start Complete Analysis</button>
      </form>

      <div id="progressSection" class="hidden">
        <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
        <div class="status testing" id="statusText">Preparing comprehensive betting analysis...</div>
      </div>

      <div id="resultsSection" class="results hidden">
        <div id="readinessCard" class="readiness-card">
          <div class="readiness-title" id="readinessTitle">Analyzing...</div>
          <div class="readiness-score" id="readinessScore">-</div>
          <div id="readinessDescription">Complete analysis in progress...</div>
        </div>

        <div class="summary-grid" id="summaryGrid"></div>

        <div class="section">
          <h3>ðŸ“‹ Endpoint Results</h3>
          <div id="resultList"></div>
        </div>

        <div class="section">
          <h3>ðŸ†” Discovered IDs</h3>
          <pre id="discoveredIds" style="background:white;border-radius:12px;padding:16px;box-shadow:0 5px 15px rgba(0,0,0,0.05);overflow:auto;"></pre>
        </div>

        <!-- Predictions section -->
        <div class="section">
          <h3>ðŸŽ¯ Bot Predictions</h3>
          <div style="display:flex; gap:12px; margin-bottom:12px;">
            <button class="btn btn-primary" id="predictionsBtn">ðŸ”® Load Predictions</button>
          </div>
          <div id="predictionsNotice" class="status hidden">Run the analysis first, then load predictions.</div>
          <div id="predictionsList"></div>
        </div>

        <div class="section">
          <h3>ðŸ“„ Complete Analysis Report</h3>
          <button class="btn btn-success" id="downloadBtn">ðŸ“¥ Download Complete Report</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let testInterval;
    let isTestRunning = false;

    document.getElementById('analysisForm').addEventListener('submit', startAnalysis);
    document.getElementById('downloadBtn').addEventListener('click', downloadReport);
    document.getElementById('predictionsBtn').addEventListener('click', loadPredictions);

    async function startAnalysis(e) {
      e.preventDefault();
      const apiToken = document.getElementById('apiToken').value.trim();
      if (!apiToken || apiToken.length < 10) {
        alert('Please enter a valid SportMonks API token (at least 10 characters)');
        return;
      }
      try {
        const res = await fetch('/api/start-test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ api_token: apiToken })
        });
        const data = await safeJson(res);
        if (!res.ok) throw new Error(data?.error || 'Failed to start analysis');

        isTestRunning = true;
        document.getElementById('startBtn').disabled = true;
        document.getElementById('startBtn').textContent = 'ðŸ”„ Analysis Running...';
        document.getElementById('progressSection').classList.remove('hidden');
        startProgressPolling();
      } catch (err) {
        alert('Error: ' + err.message);
        document.getElementById('startBtn').disabled = false;
        document.getElementById('startBtn').textContent = 'ðŸš€ Start Complete Analysis';
      }
    }

    function startProgressPolling() {
      testInterval = setInterval(async () => {
        try {
          const res = await fetch('/api/test-progress');
          const data = await safeJson(res);
          updateProgress(data?.progress || { current: 0, total: 0, status: 'idle' });

          if (data?.progress?.status === 'completed') {
            clearInterval(testInterval);
            isTestRunning = false;
            await loadResults();
            // auto-load predictions when done
            await loadPredictions();
          } else if (String(data?.progress?.status || '').includes('error')) {
            clearInterval(testInterval);
            isTestRunning = false;
            document.getElementById('statusText').textContent = 'Error: ' + data.progress.status;
            document.getElementById('statusText').className = 'status error';
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').textContent = 'ðŸš€ Start Complete Analysis';
          }
        } catch (err) {
          console.error('Error fetching progress:', err);
        }
      }, 1000);
    }

    function updateProgress(progress) {
      const progressBar = document.getElementById('progressBar');
      const statusText = document.getElementById('statusText');
      const pct = progress.total > 0 ? (progress.current / progress.total) * 100 : 0;
      progressBar.style.width = pct + '%';

      if (progress.status === 'running') {
        statusText.textContent = `${progress.current_test || 'Working...'} (${progress.current}/${progress.total})`;
        statusText.className = 'status testing';
      } else if (progress.status === 'completed') {
        statusText.textContent = 'Complete professional analysis finished! ðŸŽ‰';
        statusText.className = 'status completed';
      } else {
        statusText.textContent = 'Idle';
      }
    }

    async function loadResults() {
      try {
        const res = await fetch('/api/test-results');
        const data = await safeJson(res);
        if (!res.ok) throw new Error(data?.error || 'Failed to load results');

        displayResults(data);
        document.getElementById('resultsSection').classList.remove('hidden');
        document.getElementById('startBtn').disabled = false;
        document.getElementById('startBtn').textContent = 'ðŸš€ Start Complete Analysis';
      } catch (err) {
        console.error('Error loading results:', err);
        alert('Error loading results: ' + err.message);
      }
    }

    function displayResults(payload) {
      const summary = payload?.summary || { total:0, successful:0, failed:0, success_rate:0, avg_response_time:0, total_data_items:0 };
      const results = Array.isArray(payload?.results) ? payload.results : [];
      const ids = payload?.discovered_ids || {};
      const analysis = payload?.analysis || {};

      const sr = Number(summary.success_rate) || 0;
      let level = 'insufficient';
      if (sr >= 90) level = 'excellent';
      else if (sr >= 70) level = 'good';
      else if (sr >= 40) level = 'moderate';

      const readinessCard = document.getElementById('readinessCard');
      readinessCard.className = `readiness-card readiness-${level}`;
      document.getElementById('readinessTitle').textContent = level.toUpperCase();
      document.getElementById('readinessScore').textContent = `${Math.round(sr)}/100`;
      document.getElementById('readinessDescription').textContent =
        level === 'excellent' ? 'You have robust coverage for a professional-grade bot.' :
        level === 'good' ? 'Solid coverage. You can build an effective bot.' :
        level === 'moderate' ? 'Basic bot possible; consider adding more endpoints.' :
        'Coverage too thinâ€”fix failing endpoints.';

      document.getElementById('summaryGrid').innerHTML = `
        <div class="stat-card"><div class="stat-value">${summary.total}</div><div class="stat-label">Endpoints Tested</div></div>
        <div class="stat-card"><div class="stat-value" style="color:#27ae60">${summary.successful}</div><div class="stat-label">Successful</div></div>
        <div class="stat-card"><div class="stat-value" style="color:#e74c3c">${summary.failed}</div><div class="stat-label">Failed</div></div>
        <div class="stat-card"><div class="stat-value">${summary.success_rate}%</div><div class="stat-label">Success Rate</div></div>
        <div class="stat-card"><div class="stat-value">${summary.avg_response_time}s</div><div class="stat-label">Avg. Response Time</div></div>
        <div class="stat-card"><div class="stat-value">${(summary.total_data_items||0).toLocaleString()}</div><div class="stat-label">Data Items</div></div>
      `;

      const resultList = document.getElementById('resultList');
      if (!results.length) {
        resultList.innerHTML = '<p>No results yet.</p>';
      } else {
        resultList.innerHTML = results.map(r => {
          const ok = r.success;
          const color = ok ? '#27ae60' : '#e74c3c';
          const msg = ok ? `${r.data_count} items` : (r.errors && r.errors[0]) || `HTTP ${r.status_code}`;
          const rt = (typeof r.response_time === 'number') ? r.response_time.toFixed(2) : r.response_time;
          return `
            <div class="recommendation-item" style="border-left-color:${color}">
              <strong>${r.endpoint}</strong><br/>
              Status: <span style="color:${color}">${ok ? 'OK' : 'Failed'}</span> â€” ${msg} â€” ${rt}s
            </div>
          `;
        }).join('');
      }

      document.getElementById('discoveredIds').textContent = JSON.stringify(ids, null, 2);
    }

    async function loadPredictions() {
      const btn = document.getElementById('predictionsBtn');
      const list = document.getElementById('predictionsList');
      const notice = document.getElementById('predictionsNotice');

      btn.disabled = true;
      const originalText = btn.textContent;
      btn.textContent = 'ðŸ”„ Loading...';
      notice.classList.add('hidden');

      try {
        const res = await fetch('/api/predictions');
        const data = await safeJson(res);

        if (!res.ok) throw new Error((data && data.message) || 'Failed to load predictions');

        const preds = (data && data.predictions) || [];
        if (!preds.length) {
          list.innerHTML = `<p>No predictions available yet. Make sure todayâ€™s fixtures had odds (market 1 and/or 80).</p>`;
        } else {
          list.innerHTML = preds.map(renderPredictionCard).join('');
        }
      } catch (err) {
        list.innerHTML = `<div class="status error">Error: ${err.message}</div>`;
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    function renderPredictionCard(p) {
      const best = p.best;
      const sels = Array.isArray(p.selections) ? p.selections : [];
      const bestHtml = best ? `
        <div class="recommendation-item" style="border-left-color:#27ae60">
          <strong>Best:</strong> ${best.market} â€” <em>${best.pick}</em> @ <strong>${best.odds}</strong><br/>
          Edge: ${(best.edge * 100).toFixed(1)}% &middot; Kelly (Â¼): ${(best.kelly_fraction * 100).toFixed(1)}% 
          ${best.bookmaker_id ? `&middot; Bookmaker ID: ${best.bookmaker_id}` : ''}
          <br/><small>${best.notes || ''}</small>
        </div>` : `
        <div class="recommendation-item" style="border-left-color:#f39c12">
          No positive-edge selection found. Showing all computed selections below.
        </div>`;

      const listHtml = sels.map(s => `
        <div class="recommendation-item" style="border-left-color:${s.edge > 0 ? '#27ae60' : '#e74c3c'}">
          ${s.market} â€” <em>${s.pick}</em> @ <strong>${s.odds}</strong>
          &middot; Edge: ${(s.edge * 100).toFixed(1)}%
          &middot; Kelly (Â¼): ${(s.kelly_fraction * 100).toFixed(1)}%
          ${s.bookmaker_id ? `&middot; BM: ${s.bookmaker_id}` : ''}
          <br/><small>${s.notes || ''}</small>
        </div>
      `).join('');

      return `
        <div class="roadmap-phase">
          <div class="phase-header">
            <div class="phase-title">${p.name || 'Fixture ' + p.fixture_id}</div>
            <div class="phase-duration">${p.starting_at ? new Date(p.starting_at).toLocaleString() : ''}</div>
          </div>
          ${bestHtml}
          ${listHtml}
        </div>
      `;
    }

    async function downloadReport() {
      const button = document.getElementById('downloadBtn');
      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = 'ðŸ“¥ Generating Report...';
      try {
        const res = await fetch('/api/download-report');
        if (!res.ok) {
          const data = await safeJson(res);
          throw new Error(data?.error || 'Failed to download report');
        }
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sportmonks_test_results_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        window.URL.revokeObjectURL(url);
        button.textContent = 'âœ… Downloaded!';
        setTimeout(() => { button.textContent = originalText; button.disabled = false; }, 2000);
      } catch (err) {
        alert('Error downloading report: ' + err.message);
        button.textContent = originalText;
        button.disabled = false;
      }
    }

    async function safeJson(res) {
      try { return await res.json(); } catch { return null; }
    }
  </script>
</body>
</html>